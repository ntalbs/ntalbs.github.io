<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-2098194-3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-2098194-3');</script><meta charset=utf-8><meta name=google-site-verification content="U8HPz3to00q8wRxuKaw82QsuVvOzGyPxcWhySSYAjOE"><meta name=viewport content="width=device-width,initial-scale=1"><title>생각해볼 문제 @ntalbs' stuff</title><link rel="shortcut icon" href=/images/favicon.ico><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/xcode.css></head><body><div id=progress><div id=bar></div><div class=container><div id=scroll-title>생각해볼 문제</div></div></div><nav class=navbar role=navigation><div class=container><div class=navbar-header><button type=button class="navbar-toggle unselectable" data-toggle=collapse data-target=#nav-items>+</button>
<a class="navbar-brand unselectable" href=/>@ntalbs' stuff</a></div><div class="navbar-items collapsed" id=nav-items><ul><li><a class=unselectable href=/archive/>Archive</a></li><li><a class=unselectable href=/tags/>Tags</a></li><li><a class=unselectable href=/about/>About</a></li></ul></div></div></nav><header class=page-head><div class=container><p class=blog-description>내 이 세상 도처에서 쉴 곳을 찾아보았으나, 마침내 찾아낸, 컴퓨터가 있는 구석방보다 나은 곳은 없더라.</p></div></header><main class=container role=main><article class=post><header><p class=post-meta><time datetime=2010-12-15 itemprop=datePublished>2010-12-15</time>
on
<a href=/tags/db/>DB</a>
<a href=/tags/sql/>SQL</a></p><h1 class=post-title>생각해볼 문제</h1></header><section class=post-content><p>1부터 100까지 더하는 프로그램을 짜라면 많은 프로그래머들이 다음과 같이 <code>for</code> 루프로 1부터 100까지 돌면서 합을 구하는 형식으로 코드를 작성할 것이다. (Python으로 구현)</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>sum1</span><span class=p>(</span><span class=n>n</span><span class=p>)</span><span class=p>:</span>
  <span class=n>s</span> <span class=o>=</span> <span class=mi>0</span>
  <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>n</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=p>:</span>
    <span class=n>s</span> <span class=o>+</span><span class=o>=</span> <span class=n>i</span>
  <span class=k>return</span> <span class=n>s</span>
</code></pre></div><p>컴퓨터는 이런 식의 반복 계산을 잘 하므로 작은 수에 대해서는 이렇게 작성해도 큰 상관은 없을 것이다. 물론 비효율적이기는 하지만. 좀더 효율적으로 작성하려면 간단한 공식을 이용하면 된다.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>sum2</span><span class=p>(</span><span class=n>n</span><span class=p>)</span><span class=p>:</span>
  <span class=k>return</span> <span class=n>n</span> <span class=o>*</span> <span class=p>(</span><span class=n>n</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</code></pre></div><p><a href=http://ukja.tistory.com/362>Set-based Approach</a>에서 주문 간격 평균을 구하는 문제도 사실은 위와 비슷한 경우라 할 수 있다. (문제는 원래 페이지 참조) 테이블은 다음과 같다. (컬럼 이름을 약간 수정했다.)</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>create</span> <span class=k>table</span> <span class=n>orders</span><span class=p>(</span>
  <span class=n>member_no</span> <span class=nb>int</span><span class=p>,</span> <span class=c1>-- 회원번호
</span><span class=c1></span>  <span class=n>order_no</span>  <span class=nb>int</span><span class=p>,</span> <span class=c1>-- 주문번호
</span><span class=c1></span>  <span class=n>order_dt</span>  <span class=nb>date</span> <span class=c1>-- 주문일자
</span><span class=c1></span><span class=p>)</span><span class=p>;</span>
</code></pre></div><p>테스트를 위해 샘플 데이터도 넣었다. (테스트는 PostgreSQL에서 진행)</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>insert</span> <span class=k>into</span> <span class=n>orders</span> <span class=k>values</span>
<span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>2010-12-01</span><span class=s1>&#39;</span><span class=p>)</span><span class=p>,</span>
<span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>2010-12-10</span><span class=s1>&#39;</span><span class=p>)</span><span class=p>,</span>
<span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=s1>&#39;</span><span class=s1>2010-12-15</span><span class=s1>&#39;</span><span class=p>)</span><span class=p>;</span>
</code></pre></div><p>개발자라면 주문 간격의 평균을 구하라는 문제를 보는 순간 먼저 날짜 간격을 계산한 다음 그에 대한 평균을 구해야겠다고 생각할 것이다. SQL의 윈도우 함수(window function 또는 windowing function, 오라클에서는 analytic function)을 모르면 약간 고민을 하겠지만 이를 알고 있다면 망설임 없이 날짜로 정렬한 다음 현재 날짜에서 바로 전 레코드의 날짜를 빼서 기간을 구하고 이 기간에 대한 평균을 구하려 할 것이다.</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>select</span> <span class=k>avg</span><span class=p>(</span><span class=n>order_dt</span> <span class=o>-</span> <span class=n>priv_order_dt</span><span class=p>)</span>
<span class=k>from</span> <span class=p>(</span>
  <span class=k>select</span>
    <span class=n>order_dt</span><span class=p>,</span>
    <span class=n>lag</span><span class=p>(</span><span class=n>order_dt</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
      <span class=n>over</span> <span class=p>(</span><span class=n>partition</span> <span class=k>by</span> <span class=n>member_no</span>
          <span class=k>order</span> <span class=k>by</span> <span class=n>order_dt</span><span class=p>)</span> <span class=n>priv_order_dt</span>
  <span class=k>from</span> <span class=n>orders</span> <span class=k>where</span> <span class=n>member_no</span><span class=o>=</span><span class=mi>100</span>
  <span class=p>)</span> <span class=n>a</span>
<span class=p>;</span>
</code></pre></div><p>그러나 평균이 무엇인지를 잘 생각해보면 좀더 간단하게 구할 수 있다는 걸 알 수 있다.</p><p><img src=/2010/12-15-sql-problem/2010-12-15-1.png alt></p><p>날짜가 d<sub>1</sub>(처음 주문한 날짜)부터 d<sub>n</sub>(마지막 주문한 날짜)까지 있다면 각 주문 간격은
d<sub>2</sub>-d<sub>1</sub>, d<sub>3</sub>-d<sub>2</sub>, ..., d<sub>n</sub> - d<sub>n-1</sub>가 된다. 날짜 개수가 n개이므로 각 날짜 사이의 기간 개수는 n-1개가 된다. 따라서 평균을 구하는 식은 다음과 같이 단순화할 수 있다.</p><p><img src=/2010/12-15-sql-problem/2010-12-15-2.png alt></p><p>즉, 마지막 날짜에서 처음 날짜를 뺀 다음 기간 개수로 나눠주면 되는 것이다. 앞에서 윈도우 함수까지 동원해가며 작성했던 SQL은 사실 수식을 단순화하기 전의 방법(수식 첫 줄)으로 기간의 평균을 구한 것이다.</p><p>그러나 마지막의 단순한 식을 이용하면 SQL도 단순해진다.</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>select</span> <span class=p>(</span><span class=k>max</span><span class=p>(</span><span class=n>order_dt</span><span class=p>)</span> <span class=o>-</span> <span class=k>min</span><span class=p>(</span><span class=n>order_dt</span><span class=p>)</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
<span class=k>from</span> <span class=n>orders</span>
<span class=k>where</span> <span class=n>member_no</span> <span class=o>=</span> <span class=mi>100</span><span class=p>;</span>
</code></pre></div><p>그런데 <code>count(*)</code>가 1인 경우, 즉 날짜가 하나뿐인 경우에는 기간이란게 있을 수 없다. 위 SQL도 분모가 0이 되기 때문에 문제가 생긴다. 따라서 다음과 같이 <code>count(*)</code>가 1인 경우에 대해 따로 처리하도록 수정해야 한다.</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>select</span>
  <span class=k>case</span> <span class=k>when</span> <span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span> <span class=o>=</span> <span class=mi>1</span> <span class=k>then</span>
    <span class=k>null</span>
  <span class=k>else</span>
    <span class=p>(</span><span class=k>max</span><span class=p>(</span><span class=n>order_dt</span><span class=p>)</span> <span class=o>-</span> <span class=k>min</span><span class=p>(</span><span class=n>order_dt</span><span class=p>)</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
  <span class=k>end</span>
<span class=k>from</span> <span class=n>orders</span>
<span class=k>where</span> <span class=n>member_no</span> <span class=o>=</span> <span class=mi>100</span><span class=p>;</span>
</code></pre></div><p>프로그램을 작성할 때, 또는 SQL을 작성할 때 아무 생각없이 코드를 작성하지 말아야 한다는 걸 깨닫게 해주는 좋은 문제다.</p><h2 id=참고>참고</h2><ul><li>위 SQL 코드는 <a href=http://ukja.tistory.com/362>조동욱 님의 블로그에 올라온 글</a>과 그에 달린 답글을 참고하며 작성한 것이다.</li><li>SQL을 작성할 때 한번 더 생각하게 해주는 좋은 예제지만 집합적 사고와는 그다지 관계가 없어 보인다.</li></ul></section><footer class=post-footer><div class="social button-box"><a href=https://twitter.com/share class=twitter-share-button data-show-count=false>Tweet</a>
<a class=twitter-follow-button href=https://twitter.com/ntalbs data-show-count=false>Follow @ntalbs</a>
<script async src=//platform.twitter.com/widgets.js></script></div><nav id=article-nav><a class="article-nav-link-wrap previous" href=https://ntalbs.github.io/2011/int-min-value/ id=article-nav-newer>Integer.MIN_VALUE</a>
<a class="article-nav-link-wrap next" href=https://ntalbs.github.io/2010/parameter-argument/ id=article-nav-older>parameter와 argument</a></nav></footer></article></main><section class=section><div class=container><aside><div id=disqus_thread></div></aside><script type=text/javascript>var disqus_shortname='ntalbs-stuff';(function(){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p></p></div></section><script src=https://ntalbs.github.io/js/index.js type=text/javascript></script><footer class=page-bottom><div class=inner><section class=copyright>© 2008-2020 <a href=/about>ntalbs</a></section><section class=poweredby>Powered by <a class=icon-ghost href=https://gohugo.io>Hugo</a></section></div></footer></body></html>