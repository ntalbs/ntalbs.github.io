<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-2098194-3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-2098194-3');</script><meta charset=utf-8><meta name=google-site-verification content="U8HPz3to00q8wRxuKaw82QsuVvOzGyPxcWhySSYAjOE"><meta property="og:image" content="https://ntalbs.github.io/images/ntalbs.jpg"><meta name=viewport content="width=device-width,initial-scale=1"><title>Guava Cache 제대로 사용하기 @ntalbs' stuff</title><link rel="shortcut icon" href=/images/favicon.ico><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/highlight.css></head><body><div id=progress><div id=bar></div><div class=container><div id=scroll-title>Guava Cache 제대로 사용하기</div></div></div><nav class=navbar role=navigation><div class=container><div class=navbar-header><button type=button class="navbar-toggle unselectable" data-toggle=collapse data-target=#nav-items>+</button>
<a class="navbar-brand unselectable" href=/>@ntalbs' stuff</a></div><div class="navbar-items collapsed" id=nav-items><ul><li><a class=unselectable href=/archive/>Archive</a></li><li><a class=unselectable href=/tags/>Tags</a></li><li><a class=unselectable href=/about/>About</a></li><li><a id=mode-switch class=unselectable href=#></a></li></ul></div></div></nav><header class=page-head><div class=container><p class=blog-description>내 이 세상 도처에서 쉴 곳을 찾아보았으나, 마침내 찾아낸, 컴퓨터가 있는 구석방보다 나은 곳은 없더라.</p></div></header><main class=container role=main><article class=post><header><p class=post-meta><time datetime=2015-06-10 itemprop=datePublished>2015-06-10</time>
on
<a href=/tags/java/>Java</a></p><h1 class=post-title>Guava Cache 제대로 사용하기</h1></header><section class=post-content><p><a href=https://code.google.com/p/guava-libraries/wiki/CachesExplained>Google Guava Cache</a>는 캐시를 쉽게 사용할 수 있도록 다양한 기능을 제공한다. 간단한 코드로 캐시 크기, 캐시 시간, 데이터 로딩 방법, 데이터 리프레시 방법 등을 제어할 수 있다. 회사에서도 성능 향상을 위해 Guava 캐시가 널리 사용하고 있는데, 최근 캐시 관련 코드를 보다가 이상한 점을 발견했다.</p><p>Guava 캐시는 <code>CacheBuilder</code>를 이용해 쉽게 만들 수 있다. <code>LoadingCache</code>를 사용하면 <code>CacheLoader</code>의 <code>load</code>와 <code>loadAll</code> 메서드를 오버라이드해 데이터 로딩 방법을 지정할 수 있다. 그런데 회사 코드에서 캐시를 사용하는 부분은 거의 대부분 다음과 같은 패턴으로 작성되어 있었다. 여기서는 <code>Product</code> 객체를 캐시하며, 원천 데이터는 <code>productService</code>로부터 가져온다고 가정하자.</p><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=n>Cache</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>,</span> <span class=n>Product</span><span class=o>&gt;</span> <span class=n>productCache</span> <span class=o>=</span> <span class=n>CacheBuilder</span><span class=o>.</span><span class=na>newBuilder</span><span class=o>()</span>
    <span class=o>.</span><span class=na>maximumSize</span><span class=o>(</span><span class=n>MAX_SIZE</span><span class=o>)</span>
    <span class=o>.</span><span class=na>expireAfterWrite</span><span class=o>(</span><span class=n>DURATION</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MINUTES</span><span class=o>)</span>
    <span class=o>.</span><span class=na>build</span><span class=o>();</span>

<span class=o>...</span>

<span class=kd>public</span> <span class=n>Product</span> <span class=nf>getProduct</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>reloadIfNecessary</span><span class=o>(</span><span class=n>Lists</span><span class=o>.</span><span class=na>newArrayList</span><span class=o>(</span><span class=n>key</span><span class=o>));</span>
  <span class=k>return</span> <span class=n>productCache</span><span class=o>.</span><span class=na>getIfPresent</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
<span class=o>}</span>

<span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Product</span><span class=o>&gt;</span> <span class=nf>getProducts</span><span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span> <span class=n>keys</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>reloadIfNecessary</span><span class=o>(</span><span class=n>keys</span><span class=o>);</span>
  <span class=n>List</span><span class=o>&lt;</span><span class=n>Product</span><span class=o>&gt;</span> <span class=n>products</span> <span class=o>=</span> <span class=n>Lists</span><span class=o>.</span><span class=na>newArrayList</span><span class=o>();</span>
  <span class=k>for</span> <span class=o>(</span><span class=n>Key</span> <span class=n>key</span> <span class=o>:</span> <span class=n>keys</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>Product</span> <span class=n>p</span> <span class=o>=</span> <span class=n>productCache</span><span class=o>.</span><span class=na>getIfPresent</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>p</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
      <span class=n>products</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>p</span><span class=o>);</span>
    <span class=o>}</span>
  <span class=o>}</span>
  <span class=k>return</span> <span class=n>products</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></div><p><code>Product</code> 객체를 얻기 전에 항상 <code>reloadIfNecessary</code>를 호출한다. <code>reloadIfNecessary</code>는 다음과 같이 구현되어 있다.</p><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=kt>void</span> <span class=nf>reloadIfNecessary</span><span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span> <span class=n>keys</span><span class=o>)</span> <span class=o>{</span>
  <span class=k>try</span> <span class=o>{</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>Product</span><span class=o>&gt;</span> <span class=n>toReload</span> <span class=o>=</span> <span class=n>Lists</span><span class=o>.</span><span class=na>newArrayList</span><span class=o>();</span>
    <span class=k>for</span> <span class=o>(</span><span class=n>Key</span> <span class=n>key</span> <span class=o>:</span> <span class=n>keys</span><span class=o>)</span> <span class=o>{</span>
      <span class=k>if</span> <span class=o>(</span><span class=n>productCache</span><span class=o>.</span><span class=na>getIfPresent</span><span class=o>(</span><span class=n>key</span><span class=o>)</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>toReload</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
      <span class=o>}</span>
    <span class=o>}</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>CollectionUtils</span><span class=o>.</span><span class=na>isNotEmpty</span><span class=o>(</span><span class=n>toReload</span><span class=o>))</span> <span class=o>{</span>
      <span class=n>List</span><span class=o>&lt;</span><span class=n>Product</span><span class=o>&gt;</span> <span class=n>products</span> <span class=o>=</span> <span class=n>productService</span><span class=o>.</span><span class=na>findByIds</span><span class=o>(</span><span class=n>toReload</span><span class=o>);</span>
      <span class=n>productCache</span><span class=o>.</span><span class=na>putAll</span><span class=o>(</span><span class=n>Maps</span><span class=o>.</span><span class=na>uniqueIndex</span><span class=o>(</span><span class=n>products</span><span class=o>,</span> <span class=n>Product</span><span class=o>.</span><span class=na>keyFunc</span><span class=o>));</span>
    <span class=o>}</span>
  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;Reload product-cache exception : &#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p><code>reloadIfNecessary</code> 메서드가 하는 일은, 요청한 키 목록에 대한 아이템이 캐시에 있는지 살펴보고 없는 키에 대해서는 다른 서비스를 통해 아이템을 구해 캐시에 채워 넣는 것이다.</p><p>왜 이렇게 했을까? 캐시에 없는 데이터를 캐시로 로드하는 기능은 <code>LoadingCache</code>에 있는 기능이다. 이와 동일한 코드가 <code>LoadingCache</code>에 이미 있으므로 위 코드는 불필요하다. 단지 캐시를 생성할 때 <code>CacheLoader</code>를 만들어 넣어주면 된다.</p><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=n>LoadingCache</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>,</span> <span class=n>Product</span><span class=o>&gt;</span> <span class=n>productCache</span> <span class=o>=</span> <span class=n>CacheBuilder</span><span class=o>.</span><span class=na>newBuilder</span><span class=o>()</span>
    <span class=o>.</span><span class=na>maximumSize</span><span class=o>(</span><span class=n>MAX_SIZE</span><span class=o>)</span>
    <span class=o>.</span><span class=na>expireAfterWrite</span><span class=o>(</span><span class=n>DURATION</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MINUTES</span><span class=o>)</span>
    <span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=k>new</span> <span class=n>CacheLoader</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>,</span> <span class=n>Product</span><span class=o>&gt;()</span> <span class=o>{</span>
      <span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Product</span> <span class=nf>load</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>productService</span><span class=o>.</span><span class=na>findById</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
      <span class=o>}</span>

      <span class=nd>@Override</span> <span class=kd>public</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>,</span> <span class=n>Product</span><span class=o>&gt;</span> <span class=nf>loadAll</span><span class=o>(</span><span class=n>Iterable</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Key</span><span class=o>&gt;</span> <span class=n>keys</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>List</span><span class=o>&lt;</span><span class=n>Product</span><span class=o>&gt;</span> <span class=n>products</span> <span class=o>=</span> <span class=n>productService</span><span class=o>.</span><span class=na>findByIds</span><span class=o>(</span><span class=n>keys</span><span class=o>);</span>
        <span class=k>return</span> <span class=n>Maps</span><span class=o>.</span><span class=na>uniqueIndex</span><span class=o>(</span><span class=n>products</span><span class=o>,</span> <span class=n>Product</span><span class=o>.</span><span class=na>keyFunc</span><span class=o>);</span>
      <span class=o>}</span>
   <span class=o>});</span>
</code></pre></div><p><code>LoadingCache</code>에서 <code>get</code> 또는 <code>getAll</code> 메서드를 통해 아이템을 얻으려 할 때 해당 아이템이 없으면 <code>load</code> 또는 <code>loadAll</code> 메서드가 호출되어 캐이에 데이터를 채울 것이다. <code>loadAll</code>은 리턴 타입이 <code>Map&lt;Key, Product></code>인데 <code>productService.findByIds</code>의 리턴 타입은 <code>List&lt;Product></code>기 때문에 변환을 위한 코드가 추가되었다. <code>Product.keyFunc</code>는 <code>Product</code>로부터 <code>Key</code>를 얻는 함수(Guava의 <code>Function</code>)다.</p><p>이제 <code>getProduct</code>와 <code>getProducts</code>도 다음과 같이 수정할 수 있다.</p><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=n>Product</span> <span class=nf>getProduct</span><span class=o>(</span><span class=n>Key</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
  <span class=k>try</span> <span class=o>{</span>
    <span class=k>return</span> <span class=n>productCache</span><span class=o>.</span><span class=na>getUnchecked</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ExecuteException</span> <span class=n>x</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
  <span class=o>}</span>
<span class=o>}</span>

<span class=kd>public</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>,</span> <span class=n>Product</span><span class=o>&gt;</span> <span class=nf>getProducts</span><span class=o>(</span><span class=n>Iterable</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span> <span class=n>keys</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ExecuteException</span> <span class=o>{</span>
  <span class=k>try</span> <span class=o>{</span>
    <span class=k>return</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>,</span> <span class=n>Product</span><span class=o>&gt;</span> <span class=n>m</span> <span class=o>=</span> <span class=n>productCache</span><span class=o>.</span><span class=na>getAll</span><span class=o>(</span><span class=n>keys</span><span class=o>);</span>
  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ExecuteException</span> <span class=n>x</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>return</span> <span class=n>productCache</span><span class=o>.</span><span class=na>getAllPresent</span><span class=o>(</span><span class=n>keys</span><span class=o>);</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>코드가 훨씬 단순해 졌다. 길이만 짧아진게 아니라 이해하기도 쉬워졌다. 수정 전의 코드는 길이도 길었을뿐 아니라 쓸데없는 잡음으로 이해하기도 어려웠다.</p><p>참고로, <code>getProducts</code>의 파라미터 타입을 <code>List&lt;Key></code>에서 <code>Iterable&lt;Key></code>로, 리턴 타입은 <code>List&lt;Product></code>에서 <code>Map&lt;Key, Product></code>로 바꾸었다. 파라미터 타입을 바꾼 이유는 <code>LoadingCache.getAll</code> 메서드의 파라미터 타입과 맞추기 위해서다. <code>getAll</code> 메서드가 <code>Iterable&lt;Key></code>을 파라미터로 받을 수 있는데 <code>getProducts</code>의 파라미터를 <code>List&lt;Key></code>로 제한할 필요는 없어 보인다. 물론 <code>getProducts</code>를 호출할 때 <code>List&lt;Key></code>를 전달하는 것은 가능하다.</p><p>또한 파라미터로 여러 개의 <code>Key</code>를 전달했는데 <code>Product</code>의 목록만 리턴하는 것 보다는 <code>Key</code>-<code>Product</code> 맵으로 리턴하는 것이 더 합당해 보인다. 상황에 따라 이렇게 마음대로 인터페이스를 바꾸는 게 불가능할 수도 있다. 인터페이스를 바꾸는 게 좋을지 유지하는게 좋을지 판단은 각자의 몫이다.</p><h2 id=결론>결론</h2><p>라이브러리를 사용하기로 했다면 최소한 해당 라이브러리의 사용 방법과 API를 미리 확인해야 한다. 제대로 확인하지 않고 라이브러리에 이미 있는 기능을 다시 구현하는 것은 바보 같은 짓이다. 코드만 길어지는 게 아니라 불필요한 잡음을 추가해 코드의 가독성을 떨어뜨리고 유지보수를 어렵게 만든다.</p></section><footer class=post-footer><div class="social button-box"><a href=https://twitter.com/share class=twitter-share-button data-show-count=false>Tweet</a>
<a class=twitter-follow-button href=https://twitter.com/ntalbs data-show-count=false>Follow @ntalbs</a>
<script async src=//platform.twitter.com/widgets.js></script></div><nav id=article-nav><a class="article-nav-link-wrap previous" href=https://ntalbs.github.io/2015/if-cond-condp-case/ id=article-nav-newer>if, cond, condp, case</a>
<a class="article-nav-link-wrap next" href=https://ntalbs.github.io/2015/project-euler-020/ id=article-nav-older>프로젝트 오일러 20</a></nav></footer></article></main><section class=section><div class=container><aside><div id=disqus_thread></div></aside><script type=text/javascript>var disqus_shortname='ntalbs-stuff';var permalink="https:\/\/ntalbs.github.io\/2015\/loading-cache\/".replace(/\//g,'/');var disqus_config=function(){this.page.url=permalink;this.page.identifier=permalink;};(function(){var d=document,s=d.createElement('script');s.src='https://'+disqus_shortname+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p></p></div></section><script src=https://ntalbs.github.io/js/index.js type=text/javascript></script><script src=https://ntalbs.github.io/js/mode.js type=text/javascript></script><footer class=page-bottom><div class=inner><section class=copyright>© 2008-2020 <a href=/about>ntalbs</a></section><section class=poweredby>Powered by <a class=icon-ghost href=https://gohugo.io>Hugo</a></section></div></footer></body></html>