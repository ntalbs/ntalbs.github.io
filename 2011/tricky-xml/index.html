<!DOCTYPE html><html><head><meta name="google-site-verification" content="U8HPz3to00q8wRxuKaw82QsuVvOzGyPxcWhySSYAjOE"><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>교활한 XML | ntalbs&#39; stuff</title><meta name="description" content=""><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="ntalbs' stuff"></head><body class="home-template"><nav class="navbar" role="navigation"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#nav-items">+</button> <a class="navbar-brand" href="/">@ntalbs' stuff</a></div><div class="navbar-items collapsed" id="nav-items"><ul><li><a href="/archives">Archives</a></li><li><a href="/tags">Tags</a></li><li><a href="/about">About</a></li></ul></div></div></nav><div id="progress"><div id="bar"></div><div class="container"><div id="scroll-title">교활한 XML</div></div></div><header class="site-head"><div class="container"><p class="blog-description">내 이 세상 도처에서 쉴 곳을 찾아보았으나, 마침내 찾아낸, 컴퓨터가 있는 구석방보다 나은 곳은 없더라.</p></div></header><main class="container" role="main"><article class="post"><header><p class="post-meta"><time datetime="2011-04-13T23:00:00.000Z" itemprop="datePublished">2011-04-14</time> on <a href="/tags/보안/">보안</a></p><h1 class="post-title">교활한 XML</h1></header><section class="post-content"><p>XML 파일이 프로그램을 죽일 수도 있다는 생각은 하지 못했다. XML은 그저 텍스트일 뿐이고 프로그램은 그저 파일을 읽어서 처리할 뿐인데… 그런데 다음과 같은 파일을 보고서야 그럴 수도 있다는 것을 알게 되었다.<br><a id="more"></a></p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">&lt;?xml version="1.0"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE billion [</span></div><div class="line">&lt;!ELEMENT billion (#PCDATA)&gt;</div><div class="line">&lt;!ENTITY laugh0 "ha"&gt;</div><div class="line">&lt;!ENTITY laugh1 "&amp;laugh0;&amp;laugh0;"&gt;</div><div class="line">&lt;!ENTITY laugh2 "&amp;laugh1;&amp;laugh1;"&gt;</div><div class="line">&lt;!ENTITY laugh3 "&amp;laugh2;&amp;laugh2;"&gt;</div><div class="line">&lt;!ENTITY laugh4 "&amp;laugh3;&amp;laugh3;"&gt;</div><div class="line">&lt;!ENTITY laugh5 "&amp;laugh4;&amp;laugh4;"&gt;</div><div class="line">&lt;!ENTITY laugh6 "&amp;laugh5;&amp;laugh5;"&gt;</div><div class="line">&lt;!ENTITY laugh7 "&amp;laugh6;&amp;laugh6;"&gt;</div><div class="line">&lt;!ENTITY laugh8 "&amp;laugh7;&amp;laugh7;"&gt;</div><div class="line">&lt;!ENTITY laugh9 "&amp;laugh8;&amp;laugh8;"&gt;</div><div class="line">&lt;!ENTITY laugh10 "&amp;laugh9;&amp;laugh9;"&gt;</div><div class="line">&lt;!ENTITY laugh11 "&amp;laugh10;&amp;laugh10;"&gt;</div><div class="line">&lt;!ENTITY laugh12 "&amp;laugh11;&amp;laugh11;"&gt;</div><div class="line">&lt;!ENTITY laugh13 "&amp;laugh12;&amp;laugh12;"&gt;</div><div class="line">&lt;!ENTITY laugh14 "&amp;laugh13;&amp;laugh13;"&gt;</div><div class="line">&lt;!ENTITY laugh15 "&amp;laugh14;&amp;laugh14;"&gt;</div><div class="line">&lt;!ENTITY laugh16 "&amp;laugh15;&amp;laugh15;"&gt;</div><div class="line">&lt;!ENTITY laugh17 "&amp;laugh16;&amp;laugh16;"&gt;</div><div class="line">&lt;!ENTITY laugh18 "&amp;laugh17;&amp;laugh17;"&gt;</div><div class="line">&lt;!ENTITY laugh19 "&amp;laugh18;&amp;laugh18;"&gt;</div><div class="line">&lt;!ENTITY laugh20 "&amp;laugh19;&amp;laugh19;"&gt;</div><div class="line">&lt;!ENTITY laugh21 "&amp;laugh20;&amp;laugh20;"&gt;</div><div class="line">&lt;!ENTITY laugh22 "&amp;laugh21;&amp;laugh21;"&gt;</div><div class="line">&lt;!ENTITY laugh23 "&amp;laugh22;&amp;laugh22;"&gt;</div><div class="line">&lt;!ENTITY laugh24 "&amp;laugh23;&amp;laugh23;"&gt;</div><div class="line">&lt;!ENTITY laugh25 "&amp;laugh24;&amp;laugh24;"&gt;</div><div class="line">&lt;!ENTITY laugh26 "&amp;laugh25;&amp;laugh25;"&gt;</div><div class="line">&lt;!ENTITY laugh27 "&amp;laugh26;&amp;laugh26;"&gt;</div><div class="line">&lt;!ENTITY laugh28 "&amp;laugh27;&amp;laugh27;"&gt;</div><div class="line">&lt;!ENTITY laugh29 "&amp;laugh28;&amp;laugh28;"&gt;</div><div class="line">&lt;!ENTITY laugh30 "&amp;laugh29;&amp;laugh29;"&gt;</div><div class="line">]&gt;</div><div class="line"><span class="tag">&lt;<span class="name">billion</span>&gt;</span>&amp;laugh30;<span class="tag">&lt;/<span class="name">billion</span>&gt;</span></div></pre></td></tr></table></figure><p>우리회사 프로그램이 제대로 처리하지 못한다며 고객이 보내준 XML 파일이다. 이 파일을 Chrome이나 Firefox와 같은 브라우저에서 열면 즉각 에러를 표시한다.</p><img src="/2011/tricky-xml/chrome.png" alt="chrome.png"><p>그러나 IE8에서 열면 브라우저 화면에 아무것도 나타나지 않지만 CPU를 계속 사용하고 메모리도 계속 늘어난다. 메모리 사용량이 거의 1GB가까지 늘어나는 것을 보고 죽여야 했다. IE8도 이 XML 파일을 제대로 처리하지 못하는 것이다.</p><p>파일 내용을 보면 <code>laugh0</code> ~ <code>laugh30</code>까지 31개의 엔터티를 정의하는데 <code>laugh0</code>은 “ha”로 정의되어 있고 나머지 엔터티는 이전 엔터티를 두번 참조하는 것으로 정의되어 있다. <code>laugh1</code>은 <code>laugh0</code>이 두번 나오는 것이고, <code>laugh2</code>는 <code>laugh1</code>이 두번 나오는 것이다. 이런 식으로 <code>laugh30</code>까지 간다. 따라서 엔터티를 모두 확장해보면…</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">laugh0 --&gt; ha</div><div class="line">laugh1 --&gt; haha</div><div class="line">laugh2 --&gt; hahahaha</div><div class="line">laugh3 --&gt; hahahahahahahaha</div><div class="line">laugh4 --&gt; hahahahahahahahahahahahahahahaha</div><div class="line">laugh5 --&gt; hahahahahahahahahahahahahahahahahahahahahahahahahahahahahahahaha</div><div class="line">...</div></pre></td></tr></table></figure><p><code>&lt;billion&gt;&amp;laugh30;&lt;/billion&gt;</code>을 표시하려면 “ha”를 2<sup>30</sup>번 표시해야 한다. 2<sup>30</sup>이면 1G에 해당하는 크기다. “ha”를 2바이트라고 하면 이 XML 문서를 표시하기 위해 2GB 길이의 문자열을 표시해야 하는 것이다.</p><p>이 교활한 XML 파일을 읽고는 프로그램이 죽어버리거나 제대로 처리하지 못하는 것도 이해할만하지만 잘 작성된 프로그램이라면 그러지 말아야 한다. Chrome이나 Firefox는 이런 문제가 생길 수 있다는 것을 즉각 알아채고 에러 메시지를 표시한다. 잘 작성된 프로그램이다. IE8은 그렇지 못하다.</p><p>이 XML 파일을 보고서야 XML 문서로 프로그램을 공격할 수 있다는 걸 알게 되었고, 프로그램을 작성할 때도 이런 공격에 대비를 해야 한다는 것도 알게 되었다.</p><h2 id="업데이트-2014-11-12"><a href="#업데이트-2014-11-12" class="headerlink" title="업데이트 (2014-11-12)"></a>업데이트 (2014-11-12)</h2><ul><li>윈도우7 IE11에서 위 XML 파일을 열어보면 예전의 IE8 처럼 삽질을 하지 않는다. 그저 조용히 맨 아랫줄 <code>&lt;billion&gt;&amp;laugh30;&lt;/billion&gt;</code>을 제거하고 아무런 에러 메시지도 표시하지 않는다. 브라우저가 멈춰버리지는 않지만 친절한 UX라 할 수는 없다.</li><li>Emacs(24.4.1) 에디터에서 위 XML 파일을 열면 응답하지 않는 상태가 된다. XML 소스를 scratch 버퍼에 붙여넣는 것은 되지만 이를 XML 파일로 저장하려 하면 역시 응답하지 않는 상태가 된다. 프로세스가 CPU를 계속 사용하는 것으로 보아 뭔가 삽질을 하고 있는게 분명하다.</li></ul><div class="button-box"><a href="https://twitter.com/share" class="twitter-share-button" data-show-count="false">Tweet</a> <a class="twitter-follow-button" href="https://twitter.com/ntalbs" data-show-count="false">Follow @ntalbs</a></div></section><footer class="post-footer"><nav id="article-nav"><a href="/2011/jstestdriver-exclude/" id="article-nav-newer" class="article-nav-link-wrap"><span class="article-nav-title">커버리지 분석 시 불필요한 js 파일 제외하기</span> </a><a href="/2011/probablity/" id="article-nav-older" class="article-nav-link-wrap"><span class="article-nav-title">확률 문제</span></a></nav><section id="comment"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></footer></article></main><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script><footer class="site-footer"><div class="inner"><section class="copyright">&copy; 2008-2018 <a href="/about">ntalbs</a></section><section class="poweredby">Powered by <a class="icon-ghost" href="http://hexo.io">Hexo</a></section></div></footer><script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script type="text/javascript" src="/js/jquery.fitvids.js"></script><script type="text/javascript" src="/js/index.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
   tex2jax: {
     inlineMath: [ ['$','$'], ["\\(","\\)"] ],
     processEscapes: true
   }
 });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
   tex2jax: {
     skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
   }
 });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
   var all = MathJax.Hub.getAllJax(), i;
   for(i=0; i < all.length; i += 1) {
     all[i].SourceElement().parentNode.className += ' has-jax';
   }
 });</script><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?..."></script><script>!function(e,a,t,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=a.createElement(t),o=a.getElementsByTagName(t)[0],s.async=1,s.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(s,o)}(window,document,"script",0,"ga"),ga("create","UA-2098194-3","auto"),ga("require","displayfeatures"),ga("send","pageview")</script><script type="text/javascript">var disqus_shortname="ntalbs-stuff";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
   tex2jax: {
     inlineMath: [ ['$','$'], ["\\(","\\)"] ],
     processEscapes: true
   }
 });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
   tex2jax: {
     skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
   }
 });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
   var all = MathJax.Hub.getAllJax(), i;
   for(i=0; i < all.length; i += 1) {
     all[i].SourceElement().parentNode.className += ' has-jax';
   }
 });</script><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?..."></script><script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });</script><script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>