<!DOCTYPE html><html><head><meta name="google-site-verification" content="U8HPz3to00q8wRxuKaw82QsuVvOzGyPxcWhySSYAjOE"><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>커버리지 분석 시 불필요한 js 파일 제외하기 | ntalbs&#39; stuff</title><meta name="description" content=""><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="ntalbs' stuff"></head><body class="home-template"><nav class="navbar" role="navigation"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#nav-items">+</button> <a class="navbar-brand" href="/">@ntalbs' stuff</a></div><div class="navbar-items collapsed" id="nav-items"><ul><li><a href="/archives">Archives</a></li><li><a href="/tags">Tags</a></li><li><a href="/about">About</a></li></ul></div></div></nav><div id="progress"><div id="bar"></div><div class="container"><div id="scroll-title">커버리지 분석 시 불필요한 js 파일 제외하기</div></div></div><header class="site-head"><div class="container"><p class="blog-description">내 이 세상 도처에서 쉴 곳을 찾아보았으나, 마침내 찾아낸, 컴퓨터가 있는 구석방보다 나은 곳은 없더라.</p></div></header><main class="container" role="main"><article class="post"><header><p class="post-meta"><time datetime="2011-06-03T23:00:00.000Z" itemprop="datePublished">2011-06-04</time> on <a href="/tags/JavaScript/" style="margin:0 5px">JavaScript</a><a href="/tags/CI/" style="margin:0 5px">CI</a><a href="/tags/테스팅/" style="margin:0 5px">테스팅</a><a href="/tags/커버리지/" style="margin:0 5px">커버리지</a></p><h1 class="post-title">커버리지 분석 시 불필요한 js 파일 제외하기</h1></header><section class="post-content"><p><a href="/2010/hudson-jstestdriver-coverage/">Hudson에서 JsTestDriver를 이용한 커버리지 분석 설정</a>에서 JsTestDriver로 작성한 테스트에 대해 커버리지를 어떻게 볼 수 있는지 설명했다. 그런데 이렇게 테스트 커버리지를 분석할 때 문제가 하나 있다. 외부 라이브러리가 커버리지 분석 리포트에 포함되어 커버리지 결과가 왜곡된다는 점이다.<br><a id="more"></a></p><p>이 문제는 의외로 간단하게 해결할 수 있다. JsTestDriver의 coverage 플러그인은 JsTestDriver 실행시 지정한 testOutput 디렉터리에 LCOV 포맷의<config filename="">-coverage.dat 파일을 생성하는데, 이 파일을 적절히 조작하면 된다. 파일은 텍스트 파일이며 다음과 같은 형식으로 되어 있다.</config></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">SF:/.../.../.../src1.js</div><div class="line">DA:10,1</div><div class="line">DA:11,1</div><div class="line">DA:12,1</div><div class="line">...</div><div class="line">end_of_record</div><div class="line">SF:/.../.../.../src2.js</div><div class="line">DA:12,1</div><div class="line">DA:13,1</div><div class="line">DA:16,1</div><div class="line">...</div><div class="line">end_of_record</div><div class="line">...</div></pre></td></tr></table></figure><p>각 파일에 대한 커버리지 정보를 가지고 있는데, <code>SF:{파일경로+파일이름}</code>으로 시작하고 <code>end_of_record</code>로 끝난다. 따라서 간단한 프로그램을 짜서 불필요한 파일에 대한 정보를 날린 다음 커버리지 리포트를 만들면, 제외하고 싶은 파일을 제거한 상태의 커버리지 리포트를 만들 수 있다.</p><p>이런 작업은 스크립트 언어로 처리하면 쉬울 것 같다. 회사 CI 서버에 python이 깔려 있어 python으로 간단하게 작성해봤다. (다듬을 여지가 많다. 예를 들어 input_file을 명령행 인수로 받도록 처리할 수도 있겠다.)</p><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> shutil</div><div class="line">excludeList = open(<span class="string">'exclude_coverage.txt'</span>).readlines()</div><div class="line">input_file = <span class="string">'/.../.../jsTestDriver.conf-coverage.dat'</span></div><div class="line">output_file = <span class="string">'/.../.../excluded.dat'</span></div><div class="line"></div><div class="line">input = open(input_file, <span class="string">'r'</span>)</div><div class="line">output = open(output_file,<span class="string">'w'</span>)</div><div class="line"></div><div class="line">skip = <span class="keyword">False</span></div><div class="line"><span class="keyword">for</span> l <span class="keyword">in</span> input:</div><div class="line">  <span class="keyword">if</span> l.startswith(<span class="string">'SF:'</span>):</div><div class="line">    jsName = l.split(<span class="string">'/'</span>).pop()</div><div class="line">    <span class="keyword">if</span> excludeList.count(jsName) &gt; <span class="number">0</span>:</div><div class="line">      skip = <span class="keyword">True</span></div><div class="line">  <span class="keyword">if</span> <span class="keyword">not</span> skip:</div><div class="line">    output.write(l)</div><div class="line">  <span class="keyword">if</span> l.startswith(<span class="string">'end_of_record'</span>):</div><div class="line">    skip = <span class="keyword">False</span></div><div class="line"></div><div class="line">input.close()</div><div class="line">output.close()</div><div class="line"></div><div class="line">shutil.move(output_file, input_file)</div></pre></td></tr></table></figure><p><code>exclude_coverage.txt</code> 파일에 커버리지 분석에서 제외하고 싶은 파일 이름을 넣으면, 이 프로그램이 JsTestDriver의 커버리지 데이터 파일(…-coverage.dat)에서 <code>exclude_coverage.txt</code>에 기술한 파일과 관련된 내용을 제외한다. <code>exclude_coverage.txt</code> 파일은 다음과 같은 식으로 작성하면 된다.</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">external-lib1.js</div><div class="line">external-lib2.js</div><div class="line">external-lib3.js</div><div class="line">...</div></pre></td></tr></table></figure><p>그리고 CI서버에서 genhtml을 실행하기 전에 위에서 작성한 python 프로그램을 실행하도록 설정한다.</p><img src="/2011/jstestdriver-exclude/2011-06-04-1.png" alt="2011-06-04-1.png"><p>빌드해보면 JavaScript 커버리지 리포트에 제외하고 싶었던 파일에 대한 커버리지가 빠져 있는 것을 확인할 수 있다.</p><h2 id="참조"><a href="#참조" class="headerlink" title="참조"></a>참조</h2><ul><li><a href="/2010/hudson-jstestdriver-coverage/">Hudson에서 JsTestDriver를 이용한 커버리지 분석 설정</a></li><li><a href="/2010/hudson-jstestdriver/">Hudson에서 JsTestDriver 설정</a></li></ul><div class="button-box"><a href="https://twitter.com/share" class="twitter-share-button" data-show-count="false">Tweet</a> <a class="twitter-follow-button" href="https://twitter.com/ntalbs" data-show-count="false">Follow @ntalbs</a></div></section><footer class="post-footer"><nav id="article-nav"><a href="/2011/no-such-method-error/" id="article-nav-newer" class="article-nav-link-wrap"><span class="article-nav-title">NoSuchMethodError</span> </a><a href="/2011/tricky-xml/" id="article-nav-older" class="article-nav-link-wrap"><span class="article-nav-title">교활한 XML</span></a></nav><section id="comment"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></footer></article></main><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script><footer class="site-footer"><div class="inner"><section class="copyright">&copy; 2008-2017 <a href="/about">ntalbs</a></section><section class="poweredby">Powered by <a class="icon-ghost" href="http://hexo.io">Hexo</a></section></div></footer><script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script type="text/javascript" src="/js/jquery.fitvids.js"></script><script type="text/javascript" src="/js/index.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
   tex2jax: {
     inlineMath: [ ['$','$'], ["\\(","\\)"] ],
     processEscapes: true
   }
 });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
   tex2jax: {
     skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
   }
 });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
   var all = MathJax.Hub.getAllJax(), i;
   for(i=0; i < all.length; i += 1) {
     all[i].SourceElement().parentNode.className += ' has-jax';
   }
 });</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>!function(e,a,t,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=a.createElement(t),o=a.getElementsByTagName(t)[0],s.async=1,s.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(s,o)}(window,document,"script",0,"ga"),ga("create","UA-2098194-3","auto"),ga("require","displayfeatures"),ga("send","pageview")</script><script type="text/javascript">var disqus_shortname="ntalbs-stuff";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
   tex2jax: {
     inlineMath: [ ['$','$'], ["\\(","\\)"] ],
     processEscapes: true
   }
 });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
   tex2jax: {
     skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
   }
 });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
   var all = MathJax.Hub.getAllJax(), i;
   for(i=0; i < all.length; i += 1) {
     all[i].SourceElement().parentNode.className += ' has-jax';
   }
 });</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });</script><script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>