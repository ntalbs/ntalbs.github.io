<!doctype html><html><head><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3882204692252974" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-2098194-3"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-2098194-3')</script><meta charset=utf-8><meta name=google-site-verification content="U8HPz3to00q8wRxuKaw82QsuVvOzGyPxcWhySSYAjOE"><meta property="og:image" content="https://ntalbs.github.io/images/ntalbs.jpg"><meta name=viewport content="width=device-width,initial-scale=1"><title>Duplicate lines @ntalbs' stuff</title><link rel="shortcut icon" href=/images/favicon.ico><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/highlight.css></head><body><div id=progress><div id=bar></div><div class=container><div id=scroll-title>Duplicate lines</div></div></div><nav class=navbar role=navigation><div class=container><div class=navbar-header><button type=button class="navbar-toggle unselectable" data-toggle=collapse data-target=#nav-items>+</button>
<a class="navbar-brand unselectable" href=/>@ntalbs' stuff</a></div><div class="navbar-items collapsed" id=nav-items><ul><li><a class=unselectable href=/archive/>Archive</a></li><li><a class=unselectable href=/tags/>Tags</a></li><li><a class=unselectable href=/about/>About</a></li><li><a id=mode-switch class=unselectable href=#></a></li></ul></div></div></nav><header class=page-head><div class=container><p class=blog-description>내 이 세상 도처에서 쉴 곳을 찾아보았으나, 마침내 찾아낸, 컴퓨터가 있는 구석방보다 나은 곳은 없더라.</p></div></header><main class=container role=main><article class=post><header><p class=post-meta><time datetime=2018-11-01 itemprop=datePublished>2018-11-01</time>
on
<a href=/tags/emacs/>Emacs</a>
<a href=/tags/%ec%98%a4%ed%94%88%ec%86%8c%ec%8a%a4/>오픈소스</a></p><h1 class=post-title>Duplicate lines</h1></header><section class=post-content><p>예전에 Eclpse를 쓸 때 알게 된 편리한 기능이 있다. 하나는 Move lines up/down 기능으로 <code>Alt+&lt;up></code> 또는 <code>Alt+&lt;down></code> 키로 현재 선택 영역 또는 현재 행을 위/아래로 이동하는 기능이고, 다른 하나는 Duplicate lines 기능으로 <code>Cmd+Alt+&lt;down></code> 키를 누르면 현재 선택 영역 또는 현재 행을 아래로 복사하는 기능이다.</p><p>이 기능이 너무 편하고 익숙해 Emacs에서도 비슷한 기능을 구현한 패키지를 설치해 키 바인딩까지 똑같이 맞춰 사용했다.
<a href=https://github.com/emacsfodder/move-text>move-text</a> 패키지는 Eclipse의 Move lines up/down과 동일한 기능을 제공하고, <a href=https://github.com/ongaeshi/duplicate-thing>duplicate-thing</a> 패키지는 Duplicate lines과 비슷한 기능을 제공한다.</p><h2 id=불만>불만</h2><p>move-text는 큰 불만 없이 사용하고 있지만, duplicate-thing은 Eclipse와 동작이 달라 거슬렸다. duplicate-thing에서 마음에 들지 않는 점은 다음과 같다.</p><ul><li><strong>선택 영역이 확장되지 않는다.</strong><br>선택 영역이 행 중간에서 시작해 다른 행 중간에서 끝나는 경우도 duplicate-thing은 정확힌 선택된 영역만 복제한다. 실제로 이렇게 복제되는 게 필요한 경우가 있는지 모르겠다. Eclipse나 IntelliJ IDEA에서는 선택히 행 시작, 행 끝으로 확장된다.</li><li><strong>복제 후 선택 영역이 유지되지 않는다.</strong><br>영역을 선택해 <code>Cmd+Alt+&lt;down></code>을 누르면 선택 영역이 복제된 된 후 선택이 사라진다. Eclipse에서는 동일한 영역을 여러 번 복제하고 싶은 경우 <code>Cmd+Alt+&lt;down></code>을 여러 번 누르면 되지만 duplicate-thing에서는 한번 복제 후 선택이 사라지기 때문에 그렇게 할 수 없다. 물론 <code>C-u 5 Cmd+Alt+&lt;down></code>과 같은 식으로 여러 번 복제하는 것이 불가능하지는 않지만, 몇 번을 복제할 지 미리 생각해야 하는 불편함이 있다.</li></ul><p>그동안 그냥 참고 썼는데, 불현듯 내가 직접 짜면 더 잘 만들 수 있을 것 같다는 생각이 들었다. 못 할 것도 없지 않은가. ELisp을 따로 공부한 적은 없지만 Clojure를 조금 아니까 ELisp 코드도 더듬더듬 짤 수 있을 것이다. 예전에 웹 에디터를 개발했던 경험도 도움이 될 것이다.</p><h2 id=개선>개선</h2><p>duplicate-thing의 기능을 내 입맛에 맞게 수정할 수 있을지 소스 코드를 살펴보았다. 다행히 코드가 길지도 어렵지도 않았다. 기능 자체가 복잡한 게 아니니 당연하다 할 수 있다. 코드를 보니 <code>duplicate-thing</code>이란 함수 하나가 있는데 선택 영역이 있는 경우는 선택 영역을 복사하고 선택 영역이 없는 경우에는 현재 행을 복사한 붙여넣는게 전부다.</p><p>조금 끄적거리다 보니 duplicate-thing의 코드를 거의 갈아엎어 원래 코드는 거의 남지 않았다. 그래서 아예 패키지를 새로 만들고 이름을 <a href=https://github.com/ntalbs/duplicate-lines>duplicate-lines</a>라 지었다.</p><p>나는 선택 영역이 전체 행을 포함하도록 확장되게 수정하고 싶다. 따라서 다음과 같이 선택 영역의 시작 위치 <code>p1</code>과 끝 위치 <code>p2</code>를 인자로 받았다면 다음과 같이 선택 영역을 확장하는 코드를 작성했다. 선택 영역이 있는 경우에는 선택 영역을 확장하고, 선택 영역이 없는 경우에는 현재 행을 선택한다. 선택 영역이 있는 경우에는 <code>mark-active</code> 변수가 <code>t</code>가 된다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=cl><span class=p>(</span><span class=nb>defun</span> <span class=nv>duplicate-lines-expand-selection</span> <span class=p>(</span><span class=nv>p1</span> <span class=nv>p2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Expand selection to contain while lines.
</span></span></span><span class=line><span class=cl><span class=s>Expand P1 to beginning of line and P2 to end of line (or more precisely)
</span></span></span><span class=line><span class=cl><span class=s>the beginning of next line.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=k>let</span> <span class=p>(</span><span class=nv>start</span> <span class=nv>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nb>cond</span> <span class=p>(</span><span class=nv>mark-active</span>
</span></span><span class=line><span class=cl>           <span class=p>(</span><span class=nv>goto-char</span> <span class=nv>p1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>           <span class=p>(</span><span class=nv>beginning-of-line</span><span class=p>)</span>
</span></span><span class=line><span class=cl>           <span class=p>(</span><span class=k>setq</span> <span class=nv>start</span> <span class=p>(</span><span class=nv>point</span><span class=p>))</span>
</span></span><span class=line><span class=cl>           <span class=p>(</span><span class=nv>goto-char</span> <span class=nv>p2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>           <span class=p>(</span><span class=nb>unless</span> <span class=p>(</span><span class=nf>=</span> <span class=mi>0</span> <span class=p>(</span><span class=nv>current-column</span><span class=p>))</span>
</span></span><span class=line><span class=cl>             <span class=p>(</span><span class=nb>unless</span> <span class=p>(</span><span class=nv>duplicate-lines-line-start-after-forward-line-p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>               <span class=p>(</span><span class=nv>newline</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>           <span class=p>(</span><span class=k>setq</span> <span class=nv>end</span> <span class=p>(</span><span class=nv>point</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=no>t</span>
</span></span><span class=line><span class=cl>           <span class=p>(</span><span class=nv>beginning-of-line</span><span class=p>)</span>
</span></span><span class=line><span class=cl>           <span class=p>(</span><span class=k>setq</span> <span class=nv>start</span> <span class=p>(</span><span class=nv>point</span><span class=p>))</span>
</span></span><span class=line><span class=cl>           <span class=p>(</span><span class=nb>unless</span> <span class=p>(</span><span class=nv>duplicate-lines-line-start-after-forward-line-p</span><span class=p>)</span> <span class=p>(</span><span class=nv>newline</span><span class=p>))</span>
</span></span><span class=line><span class=cl>           <span class=p>(</span><span class=k>setq</span> <span class=nv>end</span> <span class=p>(</span><span class=nv>point</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=k>setq</span> <span class=nv>deactivate-mark</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nv>goto-char</span> <span class=nv>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nv>set-mark</span> <span class=nv>start</span><span class=p>)))</span>
</span></span></code></pre></div><p>선택 영역을 확장하는 것은 쉽다. <code>p1</code>을 행의 처음으로 보내고 <code>p2</code>를 다음 행의 처음으로 보내면 된다. 선택 영역이 있는데 <code>p2</code>가 행의 맨 앞(즉 <code>current-column</code> = 0)이 아니면 <code>p2</code>를 다음 행으로 보낸다. <code>duplicate-lines-line-start-after-forward-line-p</code> 함수가 그 역할을 한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=cl><span class=p>(</span><span class=nb>defun</span> <span class=nv>duplicate-lines-line-start-after-forward-line-p</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Return &#39;t if the position is beginning of line after foward-line.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>forward-line</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nf>=</span> <span class=mi>0</span> <span class=p>(</span><span class=nv>current-column</span><span class=p>)))</span>
</span></span></code></pre></div><p>이 함수는 포인트를 다음 행으로 옮긴 다음 (<code>forward-line</code>) 포인트가 행의 맨 앞에 위치하면 <code>t</code>를 리턴한다. 버퍼가 빈 줄로 끝나지 않는 경우 <code>p2</code>가 맨 마지막 행 중간에 있다면 <code>forward-line</code>이 무시될 것이고 이 경우에는 <code>new-line</code>으로 새 행을 삽입해줘야 한다.</p><p>Emacs에서 호출할 함수 <code>duplicate-lines</code>는 다음과 같이 작성할 수 있다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=cl><span class=p>(</span><span class=nb>defun</span> <span class=nv>duplicate-lines</span> <span class=p>(</span><span class=nv>p1</span> <span class=nv>p2</span> <span class=nv>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Duplicate line or region N times.
</span></span></span><span class=line><span class=cl><span class=s>If it has active mark (P1, P2), it will expand the selection and duplicate it.
</span></span></span><span class=line><span class=cl><span class=s>If it doesn&#39;t have active mark, it will select current line and duplicate it.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>interactive</span> <span class=s>&#34;r\np&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=k>let</span> <span class=p>(</span><span class=nv>start</span> <span class=nv>end</span> <span class=nv>len</span> <span class=nv>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nv>duplicate-lines-expand-selection</span> <span class=nv>p1</span> <span class=nv>p2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=k>setq</span> <span class=nv>start</span> <span class=p>(</span><span class=nv>region-beginning</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=nv>end</span>   <span class=p>(</span><span class=nv>region-end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=nv>len</span>   <span class=p>(</span><span class=nf>-</span> <span class=nv>end</span> <span class=nv>start</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=nv>text</span>  <span class=p>(</span><span class=nv>buffer-substring</span> <span class=nv>start</span> <span class=nv>end</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nb>dotimes</span> <span class=p>(</span><span class=nv>i</span> <span class=p>(</span><span class=nb>or</span> <span class=nv>n</span> <span class=mi>1</span><span class=p>))</span> <span class=p>(</span><span class=nv>insert</span> <span class=nv>text</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nv>set-mark</span> <span class=p>(</span><span class=nf>-</span> <span class=p>(</span><span class=nv>point</span><span class=p>)</span> <span class=nv>len</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=k>setq</span> <span class=nv>deactivate-mark</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=k>setq</span> <span class=nv>transient-mark-mode</span> <span class=p>(</span><span class=nc>cons</span> <span class=ss>&#39;only</span> <span class=no>t</span><span class=p>))))</span>
</span></span></code></pre></div><p><code>(interactive "r\np")</code>는 함수가 영역 <code>p1</code>, <code>p2</code>와 함께 반복횟수 <code>n</code>을 인자로 받을 수 있게 한다. duplicate-thing에서는 선택 영역 텍스트를 복사&붙여넣기 하는 데 <code>kill-ring-save</code>와 <code>yank</code>를 사용했지만 여기서는 <code>buffer-substring</code>과 <code>insert</code>를 사용했다.</p><h2 id=pr>PR</h2><p>이걸 <a href=https://melpa.org/>Melpa</a>에 올리면 좋을 것 같았다. 내가 만든 패키지를 Melpa에 올려 여러 사람이 사용할 수 있게 한다면 정말 멋진 일일 것이다. <a href=https://github.com/melpa/melpa/blob/master/CONTRIBUTING.org>Contributing a new recipe to Melpa</a>를 자세히 읽고 가이드에 따라 <code>package-lint</code>와 <code>checkdoc</code> 경고도 모두 수정했다.</p><p>그런데 내가 작성한 패키지 기능은 duplicate-thing과 비슷해 PR이 받아들여질지도 불확실했고, duplicate-thing의 작성자에게도 예의가 아닌 것 같다는 생각이 들었다. 그래서 duplicate-thing을 포크해서 내 수정 사항을 반영한 다음 PR을 보냈는데, 닷새가 지나도록 반응이 없었다.</p><p>조급한 마음에 Melpa 관리자에게 메일을 보내 어떻게 하는 게 좋겠냐고 도움말을 청했더니 바로 답장이 왔다. 닷새는 원작자에게 별로 긴 시간이 아니니 좀더 기다려보라고. duplicate-thing과 기능이 비슷한 다른 다른 패키지도 알려주며, 많은 사람들이 비슷한 패키지를 작성했다는 사실도 덧붙였다. Melpa에서 거부된 PR 링크와 함께. 역시 내가 만든 패키지를 Melpa에 올리기는 어려울 것 같다.</p><p>마침내 duplicate-thing 작성자에게도 응답이 왔다. 자기는 주석 처리 후 복제하는 기능을 좋아하는데 내가 그 기능을 제거했기 때문에 PR을 받아들일 수 없다고 했다. 작성자가 좋아하는 기능을 마음대로 없애 버렸으니 PR이 거부된 것은 당연하다.</p><p>가만히 생각해보니 원래 선택했던 부분을 주석 처리한 다음 복제하는 기능도 유용할 것 같았다. duplicate-thing 작성자가 PR을 거부한 이유도 이 기능을 뺐기 때문이니 이게 되도록 코드를 수정하면 PR을 받아줄지도 모르겠다는 생각이 들었다. 게다가 내가 작성한 코드에서 버그도 발견했다. 내가 작성한 코드에서는 인자로 영역과 반복횟수를 받기 위해 인터랙티브 코드를 <code>r\np</code>로 설정했는데, 마크가 설정되어 있지 않은 경우에는 에러가 발생했다.</p><p>인터랙티브 코드를 다시 <code>P</code>(대문자)로 바꾸고 인자를 제거한 다음 선택 영역이 있는 경우에 영역의 시작과 끝을 함수 안에서 얻게 바꾸어 버그를 수정했다. 그리고 주석 처리 후 복제하는 기능을 구현했다. 코드를 정리해 다시 <a href=https://github.com/ongaeshi/duplicate-thing/pull/3>PR</a>을 보냈다. 이번에는 이틀만에 답이 왔다. 선택 영역을 유지하는 기능이 아주 유용하다며 PR을 병합해 주었고, Melpa에도 반영되었다.</p><h2 id=정리>정리</h2><p>Emacs 기능을 수정하는 것은 매우 즐거운 경험이었다. 간단한 기능이었지만 불편한 점을 직접 수정했다. Melpa에 내 패키지를 올릴 수 있을지도 모른다는 생각에 잠시 들떴고, 이미 비슷한 패키지가 많아 올리기 힘들다는 것을 알았을 때는 실망했다.</p><p>그러나 내가 수정한 코드가 duplcate-thing에 반영되었다. Melpa로 duplcate-thing을 설치하면 내가 수정한 코드를 볼 수 있다. duplicate-thing 사용자들은 내가 수정한 코드를 사용하게 될 것이다. 충분히 만족할만한 일이다.</p><h2 id=참고>참고</h2><ul><li><a href=https://github.com/ongaeshi/duplicate-thing>duplicate-thing</a></li><li><a href=https://github.com/ntalbs/duplicate-lines>duplicate-lines</a></li><li><a href=https://github.com/melpa/melpa/blob/master/CONTRIBUTING.org>Contributing a new recipe to Melpa</a></li><li><a href=https://emacs.stackexchange.com/questions/22162/how-to-set-mark-in-elisp-and-have-shift-selection>How to set mark in elisp and have shift selection?</a></li></ul></section><footer class=post-footer><div class="social button-box"><a href=https://twitter.com/share class=twitter-share-button data-show-count=false>Tweet</a>
<a class=twitter-follow-button href=https://twitter.com/ntalbs data-show-count=false>Follow @ntalbs</a>
<script async src=//platform.twitter.com/widgets.js></script></div><nav id=article-nav><a class="article-nav-link-wrap previous" href=/2018/project-euler-100/ id=article-nav-newer>프로젝트 오일러 100</a>
<a class="article-nav-link-wrap next" href=/2018/project-euler-099/ id=article-nav-older>프로젝트 오일러 99</a></nav></footer></article></main><section class=section><div class=container><aside><div id=disqus_thread></div></aside><script type=text/javascript>var disqus_shortname='ntalbs-stuff',permalink="https://ntalbs.github.io/2018/duplicate-lines/".replace(/\//g,'/'),disqus_config=function(){this.page.url=permalink,this.page.identifier=permalink};(function(){var e=document,t=e.createElement('script');t.src='https://'+disqus_shortname+'.disqus.com/embed.js',t.setAttribute('data-timestamp',+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p></p></div></section><script src=https://ntalbs.github.io/js/index.js type=text/javascript></script>
<script src=https://ntalbs.github.io/js/mode.js type=text/javascript></script><footer class=page-bottom><div class=inner><section class=copyright>© 2008-2022 <a href=/about>ntalbs</a></section><section class=poweredby>Powered by <a class=icon-ghost href=https://gohugo.io>Hugo</a></section></div></footer></body></html>