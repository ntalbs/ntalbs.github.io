<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-2098194-3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-2098194-3');</script><meta charset=utf-8><meta name=google-site-verification content="U8HPz3to00q8wRxuKaw82QsuVvOzGyPxcWhySSYAjOE"><meta name=viewport content="width=device-width,initial-scale=1"><title>highligh.js 서버측 렌더링 @ntalbs' stuff</title><link rel="shortcut icon" href=/images/favicon.ico><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/xcode.css></head><body><div id=progress><div id=bar></div><div class=container><div id=scroll-title>highligh.js 서버측 렌더링</div></div></div><nav class=navbar role=navigation><div class=container><div class=navbar-header><button type=button class="navbar-toggle unselectable" data-toggle=collapse data-target=#nav-items>+</button>
<a class="navbar-brand unselectable" href=/>@ntalbs' stuff</a></div><div class="navbar-items collapsed" id=nav-items><ul><li><a class=unselectable href=/archive/>Archive</a></li><li><a class=unselectable href=/tags/>Tags</a></li><li><a class=unselectable href=/about/>About</a></li></ul></div></div></nav><header class=page-head><div class=container><p class=blog-description>내 이 세상 도처에서 쉴 곳을 찾아보았으나, 마침내 찾아낸, 컴퓨터가 있는 구석방보다 나은 곳은 없더라.</p></div></header><main class=container role=main><article class=post><header><p class=post-meta><time datetime=2019-06-06 itemprop=datePublished>2019-06-06</time>
on
<a href=/tags/hugo/>hugo</a></p><h1 class=post-title>highligh.js 서버측 렌더링</h1></header><section class=post-content><p>블로그 글에 포함된 코드를 하이라이팅 하기 위해 <a href=https://highlightjs.org/>highlight.js</a>를 사용한다. highlight.js 역시 별도 JavaScript 파일을 로딩한 다음 페이지에 포함된 코드를 찾아 렌더링하는 식이라 페이지를 로드할 때마다 매번 다시 렌더링하는 비효율이 발생한다. MathJax 만큼 느리진 않지만, 가끔씩 네트워크 속도가 느린 환경에서 코드 블록이 울컥 하는 현상을 볼 수 있다. <a href=/2019/mathjax-server-side-rendering>MathJax 서버측 렌더링</a>에서 했던 것처럼 코드도 사이트를 생성할 때 한꺼번에 렌더링해두면 좋을 것 같다.</p><p>예상대로 highlight.js를 위한 CLI 도구가 있다. <a href=https://github.com/tzemanovic/highlight.js-cli>highlight.js-cli</a>를 설치하면 <code>hljs</code> 명령으로 HTML 파일에 포함된 코드를 렌더링할 수 있다.</p><pre class=console>
$ hljs --help
Usage:
  hljs [OPTIONS] [ARGS]
...
</pre><p><a href=/2019/mathjax-server-side-rendering>MathJax 서버측 렌더링</a>에서 작성한 셸 스크립트에서 <code>hljs</code>도 함께 실행하도록 수정하면 될 것 같다.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>...
  <span class=k>else</span>
    hljs &lt; <span class=nv>$src</span> <span class=p>|</span> mjpage --format svg --dollars <span class=nb>true</span> &gt; <span class=nv>$target</span>
  <span class=k>fi</span>
...
</code></pre></div><p><code>hljs</code>를 실행해 코드를 렌더링하고 그 결과를 <code>mjpage</code>로 다시 넘겨 수식을 렌더링한다. 느려터진 <code>mjpage</code>에 <code>hljs</code>까지 함께 실행시키니 HTML 페이지를 생성하는 속도가 더 느려졌다. 그러나 렌더링을 마친 페이지는 JavaScript 파일을 따로 로드해 실행할 필요가 없다. 그냥 로딩한 HTML을 그대로 보여주기만 하면 된다.</p><h2 id=업데이트>업데이트</h2><p>며칠 후 블로그를 보다가 몇몇 페이지가 왕짱 깨진 것을 발견했다. 블로그에서 <code>&lt;canvas></code>와 같은 식으로 HTML 코드를 쓴 부분이 진짜 HTML 태그로 인식되어 페이지가 엉뚱하게 표현되는 문제였다. <code>hljs</code>에 뭔가 문제가 있는 게 분명했다. HTML 파일을 <code>hljs</code>로 렌더링하면서 HTML이 어떻게 바뀌는지 확인해보니, 소스 코드 하이라이트가 필요하지 않은 부분까지 <code>hljs</code>가 수정하는 것이 눈에 띄었다.</p><p>해당 부분을 수정하고 블로그 포스트가 모두 제대로 표시되는지 다시 확인했다. HTML 태그로 인한 문제는 사라졌지만 일부 소스 코드가 제대로 렌더링되지 않는 문제가 있었다. 마크다운으로 코드블록을 작성할 때 보통 언어를 지정하는데 이게 <code>hljs</code>에서 제대로 인식되지 않는 문제였다. 버그를 수정해 원작자에게 <a href=https://github.com/tzemanovic/highlight.js-cli/pull/4>PR</a>을 보냈고, 원작자가 마스터에 병합해 주었다.</p><p>내가 수정한 <code>hljs</code>를 이용해 다시 블로그를 생성하고 모든 페이지를 다시 확인했다. 예전에 Hexo를 쓰던 때의 악몽이 되살아나는 듯 했다. 그때도 Hexo나 node.js를 업데이트하고 나면 블로그가 깨지는 일이 잦았다. Hugo로 이사하고 나서는 그런 문제가 없었는데, 괜히 사이트 최적화 한다고 삽질하다가 쓸데없이 일을 만든게 아닌가 싶다. MathJax의 경우는 서버쪽 렌더링 효과가 크게 눈에 띄었지만 highlight.js의 경우는 체감 효과가 크지 않았고 잡일만 생겼다.</p><p>node.js 기반 도구는 너무 신뢰하지 말하야 겠다. 이미 highlight.js 서버측 렌더링 작업을 끝냈으니 넘어가지만, 다시 문제가 생기면 이 부분은 걷어내야겠다.</p><h2 id=참고>참고</h2><ul><li><a href=https://github.com/tzemanovic/highlight.js-cli>highlight.js-cli</a></li><li><a href=https://github.com/tzemanovic/highlight.js-cli/pull/4>hljs 버그 수정 PR</a></li><li><a href=/tags/hexo/>Hexo 관련 포스트</a></li></ul></section><footer class=post-footer><div class="social button-box"><a href=https://twitter.com/share class=twitter-share-button data-show-count=false>Tweet</a>
<a class=twitter-follow-button href=https://twitter.com/ntalbs data-show-count=false>Follow @ntalbs</a>
<script async src=//platform.twitter.com/widgets.js></script></div><nav id=article-nav><a class="article-nav-link-wrap previous" href=https://ntalbs.github.io/2019/drilling/ id=article-nav-newer>구멍 뚫기</a>
<a class="article-nav-link-wrap next" href=https://ntalbs.github.io/2019/mathjax-server-side-rendering/ id=article-nav-older>MathJax 서버측 렌더링</a></nav></footer></article></main><section class=section><div class=container><aside><div id=disqus_thread></div></aside><script type=text/javascript>var disqus_shortname='ntalbs-stuff';(function(){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p></p></div></section><script src=https://ntalbs.github.io/js/index.js type=text/javascript></script><footer class=page-bottom><div class=inner><section class=copyright>© 2008-2020 <a href=/about>ntalbs</a></section><section class=poweredby>Powered by <a class=icon-ghost href=https://gohugo.io>Hugo</a></section></div></footer></body></html>