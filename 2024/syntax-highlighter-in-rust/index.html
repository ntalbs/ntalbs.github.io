<!doctype html><html><head><script src=/js/mode.js type=text/javascript></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3882204692252974" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-2098194-3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-2098194-3")</script><meta name=google-site-verification content="U8HPz3to00q8wRxuKaw82QsuVvOzGyPxcWhySSYAjOE"><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jce8mxrx8a")</script><meta charset=UTF-8><meta http-equiv=content-language content="ko-KR"><meta name=description content="Rust로 소스 코드 하이라이터를 구현해 보았다."><meta name=keywords content="rust,syntax highlighter"><meta property="og:title" content="Rust로 구현한 소스 코드 하이라이터 @ntalbs' stuff"><meta property="og:site_name" content="@ntalbs' stuff"><meta property="og:url" content="https://ntalbs.github.io/2024/syntax-highlighter-in-rust/"><meta property="og:description" content="Rust로 소스 코드 하이라이터를 구현해 보았다."><meta name=og:image content="https://ntalbs.github.io/images/ntalbs.jpg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@ntalbs"><meta name=twitter:creator content="@ntalbs"><meta name=viewport content="width=device-width,initial-scale=1"><title>Rust로 구현한 소스 코드 하이라이터 @ntalbs' stuff</title>
<link rel="shortcut icon" href=/images/favicon.ico><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/highlight.css></head><body><div id=progress><div id=bar></div><div class=container><div id=scroll-title>Rust로 구현한 소스 코드 하이라이터</div></div></div><nav class=navbar role=navigation><div class=container><div class=navbar-header><button type=button class="navbar-toggle unselectable" data-toggle=collapse data-target=#nav-items>+</button>
<a class="navbar-brand unselectable" href=/>@ntalbs' stuff</a></div><div class="navbar-items collapsed" id=nav-items><ul><li><input id=search type=search placeholder="Search this site" autocomplete=off></li><li><a class=unselectable href=/archive/>Archive</a></li><li><a class=unselectable href=/tags/>Tags</a></li><li><a class=unselectable href=/about/>About</a></li><li><a id=mode-switch class=unselectable href=#><svg data-bs-theme-value="dark" xmlns="http://www.w3.org/2000/svg" class="icon-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg><svg data-bs-theme-value="light" xmlns="http://www.w3.org/2000/svg" class="icon-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg></a></li></ul></div></div></nav><header class=page-head><div class=container><p class=blog-description>내 이 세상 도처에서 쉴 곳을 찾아보았으나, 마침내 찾아낸, 컴퓨터가 있는 구석방보다 나은 곳은 없더라.</p></div></header><main class=container role=main><article class=post><header><p class=post-meta><time datetime=2024-01-29 itemprop=datePublished>2024-01-29</time>
on
<a href=/tags/rust/>rust</a></p><h1 class=post-title>Rust로 구현한 소스 코드 하이라이터</h1></header><section class=post-content><p>소스 코드 하이라이터는 어떻게 만드는 것일까? Rust로 간단히 소스 코드 하이라이터를 만들어 보기로 했다. 소스 코드를 스캔해 토큰 목록을 구한 다음 토큰 타입에 따라 적절히 렌더링하면 될 것 같다.</p><h2 id=토큰-타입>토큰 타입</h2><p>토큰 종류는 다음과 같이 정의한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Debug, PartialEq)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>enum</span> <span class=nc>Token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Whitespace</span><span class=p>(</span><span class=nb>String</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NewLine</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Punctuation</span><span class=p>(</span><span class=nb>String</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=p>(</span><span class=nb>String</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>String</span><span class=p>(</span><span class=nb>String</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LineComment</span><span class=p>(</span><span class=nb>String</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BlockComment</span><span class=p>(</span><span class=nb>String</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Name</span><span class=p>(</span><span class=nb>String</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Keyword</span><span class=p>(</span><span class=nb>String</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Eof</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>Whitespace</code>는 공배를 나타낸다. <code>Whitespace</code>가 <code>NewLine</code>도 포함하게 할 수도 있지만, 렌더링 시 행번호를 출력할 때 편하게 하기 위해 따로 구분했다.</p><p>모든 특수문자나 연산자는 <code>Punction</code>으로 매핑할 것이다. 소스 코드 하이라이터에서는 각 연산자나 특수문자의 의미를 알 필요가 없다. 여기서는 모두 동일하게 렌더링할 것이다.</p><p>숫자나 문자열을 다르게 렌더링하기 위해 <code>Number</code>와 <code>String</code>을 정의했다. 주석은 <code>LineComment</code>와 <code>BlockComment</code>를 따로 구분했다.</p><p>함수명이나 변수명은 모두 <code>Name</code>으로, 키워드는 <code>Keyword</code>로 매핑할 것이다. <code>Eof</code>는 내부적으로만 사용할 것이며, 코드를 렌더링할 때는 사용하지 않는다.</p><h2 id=스캐너>스캐너</h2><p>이제 스캐너(scanner)를 만들어보자. 스캐너는 렉서(lexer) 또는 구문 분석기(lexical analyser)라고도 한다. 스캐너는 소스 코드를 읽어 토큰 목록을 생성한다. <code>Scanner</code> 구조체는 다음과 같이 정의한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Scanner</span><span class=o>&lt;</span><span class=na>&#39;a</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iter</span>: <span class=nc>Peekable</span><span class=o>&lt;</span><span class=n>Chars</span><span class=o>&lt;</span><span class=na>&#39;a</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>current_char</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=kt>char</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>Scanner</code> 구조체는 두 필드를 가진다. 입력에 대한 반복자(iterator) <code>iter</code> 필드는 반복자를 전진하지 않으면서 다음 값을 엿보기 위해 <code>Peekable</code>을 사용한다.</p><p><code>current_char</code>는 현재 문자를 저장하기 위한 필드다. 처음에는 값이 없으므로 <code>Option&lt;char></code> 타입을 사용한다.</p><p><code>peek</code>와 조합해 스캐닝 시 두 문자를 볼 수 있다. 뒤에 살펴보겠지만 토큰 타입을 정하는 데 두 문자를 봐야 알 수 있는 경우가 있다.</p><p>생성자는 다음과 같이 작성할 수 있다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>impl</span><span class=o>&lt;</span><span class=na>&#39;a</span><span class=o>&gt;</span><span class=w> </span><span class=n>Scanner</span><span class=o>&lt;</span><span class=na>&#39;a</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>fn</span> <span class=nf>new</span><span class=p>(</span><span class=n>input</span>: <span class=kp>&amp;</span><span class=na>&#39;a</span> <span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>iter</span>: <span class=nc>input</span><span class=p>.</span><span class=n>chars</span><span class=p>().</span><span class=n>peekable</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>current_char</span>: <span class=nb>Option</span>::<span class=nb>None</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>..</span><span class=p>.</span><span class=w>
</span></span></span></code></pre></div><p>그리고 <code>Scanner</code>에 다음 도우미 메서드를 추가한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>advance</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;</span><span class=kt>char</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>iter</span><span class=p>.</span><span class=n>next</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>peek</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;&amp;</span><span class=kt>char</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>iter</span><span class=p>.</span><span class=n>peek</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>is_at_end</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>peek</span><span class=p>().</span><span class=n>is_none</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>advance</code> 메서드는 다음 문자를 리턴하고 반복자를 전진한다. <code>peek</code> 메서드는 반복자를 전진하지 않으면서 다음 문자를 리턴한다. <code>is_at_end</code> 메서는 입력의 끝에 도달했는지 확인하는 메서드다.</p><p>이제 반복자를 통해 입력을 한 글자씩 읽어가며 토큰을 구할 것이다. 입력을 읽어 토큰 목록을 생성하는 메서드는 다음과 같다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>fn</span> <span class=nf>scan</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Token</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>tokens</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Token</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Vec</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=o>!</span><span class=bp>self</span><span class=p>.</span><span class=n>is_at_end</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>next_token</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>match</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Token</span>::<span class=n>Eof</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>break</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>tokens</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>token</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>tokens</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>실제로 토큰을 생성하는 메서드는 <code>next_token()</code>이다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>next_token</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>current_char</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>advance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>current_char</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>whitespace</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=sc>&#39;\n&#39;</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>newline</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=sc>&#39;&#34;&#39;</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>string</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=sc>&#39;/&#39;</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>peek</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nb>Some</span><span class=p>(</span><span class=sc>&#39;/&#39;</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>line_comment</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nb>Some</span><span class=p>(</span><span class=sc>&#39;*&#39;</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>block_comment</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nb>Some</span><span class=p>(</span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>punctuation</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>Token</span>::<span class=n>Eof</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=bp>Self</span>::<span class=n>is_punctuation</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>punctuation</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=n>is_ascii_digit</span><span class=p>()</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>number</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>name_or_keyword</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>Token</span>::<span class=n>Eof</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=whitespace>Whitespace</h3><p>현재 문자가 공백이면 <code>whitespace</code> 메서드를 호출한다. <code>whitespace</code> 메서드는 연속된 공백을 모두 묶어 <code>Whitespace</code> 토큰을 생성할 것이다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>whitespace</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>current_char</span><span class=p>.</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>peek</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>advance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>Whitespace</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=newline>Newline</h3><p>현재 문자가 줄바꿈 문자면 <code>newline</code> 메서드를 호출한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>newline</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>NewLine</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=string>String</h3><p>프로그래밍 언어에 따라 홑따옴표로 문자열을 감쌀 수도 있지만, 여기서는 문자열을 쌍따옴표로 감싼 경우만 처리한다. 쌍따옴표 문자를 만나면 <code>string</code> 메서드를 호출한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>string</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\&#34;</span><span class=s>&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>prev_char</span>: <span class=kt>char</span> <span class=o>=</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=o>&amp;</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>peek</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>match</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=sc>&#39;\n&#39;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>break</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=sc>&#39;&#34;&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>prev_char</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=sc>&#39;\\&#39;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>break</span><span class=p>,</span><span class=w> </span><span class=c1>// if prev_char==&#39;\\&#39;, then escaped
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>buf</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>prev_char</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=bp>self</span><span class=p>.</span><span class=n>advance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>advance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=sc>&#39;\n&#39;</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>(),</span><span class=w> </span><span class=c1>// non-terminated string
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=sc>&#39;&#34;&#39;</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>buf</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=sc>&#39;&#34;&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>(),</span><span class=w>    </span><span class=c1>// shouldn&#39;t come here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>(),</span><span class=w>       </span><span class=c1>// EOF, do nothing
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=nb>String</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>string</code> 메서드는 조금 복잡하다. 기본 로직은 쌍따옴표부터 시작해 문자열이 끝날 때까지 문자를 읽어들인 다음 토큰을 생성해 리턴하는 것이지만, 문자열이 제대로 끝나지 않은 경우, 문자열 안에 쌍따옴표가 있는 경우 등의 예외 처리가 필요하다.</p><p>코드를 실행할 것이 아니므로, 입력에 오류가 포함되어 있다고 해서 에러를 리턴하면 안 된다. 그냥 스캔한 대로 토큰을 리턴해 나중에 렌더러가 적절히 표현할 수 있도록 한다.</p><h3 id=punctuation>Punctuation</h3><p>모든 특수문자는 <code>Punction</code> 토큰이 되어야 하지만 예외가 있다. 쌍따옴표(<code>"</code>)는 문자열의 시작을 뜻하므로 별도 처리가 필요하다. 슬래시 문자는 뒤에 따라오는 문자에 따라 <code>LineComment</code> 또는 <code>BlockComment</code>가 될 수도 있고 그냥 <code>Punctuation</code>이 될 수도 있다.</p><p><code>/</code>는 조금 나중에 다루기로 하고 <code>Puncuation</code>을 먼저 처리하자. 다음과 같이 <code>is_punctuation</code> 도우미 함수를 만든다. 이 함수는 주어진 문자가 알파벳이나 숫자도 아니고, 공백도 아니고, 쌍따옴표도 아닌 경우에 <code>true</code>를 리턴한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>is_punctuation</span><span class=p>(</span><span class=n>c</span>: <span class=kt>char</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>c</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=n>is_alphanumeric</span><span class=p>()</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>c</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=n>is_ascii_whitespace</span><span class=p>()</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=sc>&#39;&#34;&#39;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>그리고 다음과 같이 <code>punctuation</code> 메서드를 정의한다. <code>next_token</code> 메서드에서 특수문자를 만나면 이 메서드를 호출한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>punctuation</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>current_char</span><span class=p>.</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=o>&amp;</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>peek</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=bp>Self</span>::<span class=n>is_punctuation</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>advance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>Punctuation</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>연속된 특수문자는 하나의 토큰으로 병합한다.</p><h3 id=number>Number</h3><p>숫자를 만나면 <code>number</code> 메서드를 호출한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>number</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>current_char</span><span class=p>.</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=o>&amp;</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>peek</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=n>c</span><span class=p>.</span><span class=n>is_ascii_digit</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=sc>&#39;.&#39;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=sc>&#39;_&#39;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>advance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>Number</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>숫자는 <code>3.14</code>와 같이 숫자에 <code>.</code>이 포함되어 있을 수도 있고, <code>1_000</code>과 같이 <code>_</code>가 포함될 수 있으므로 이에 대한 처리가 들어갔다. 위 구현은 숫자 전체에 소수점이 한 번만 나오는지 확인하지 않으므로 <code>1.2.3</code>과 같은 유효하지 않은 숫자도 그냥 숫자 토큰으로 변환할 것이다. 그러나 문법 하이라이터에서 이런 문제는 중요하지 않다.</p><h3 id=name-keyword>Name, Keyword</h3><p><code>LineComment</code>, <code>BlockComment</code>도 아니고 위에서 설명한 다른 토큰 타입도 아니라면 가능한 토큰은 <code>Name</code> 아니면 <code>Keyword</code>다. 그러나 <code>next_token</code> 메서드 안에서 한 글자만 보고 다음 토큰이 <code>Name</code>이 될지 <code>Keyword</code>가 될 지는 아직 알 수 없으므로, 다음과 같이 <code>name_or_keyword</code> 메서드를 작성한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>name_or_keyword</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>current_char</span><span class=p>.</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=o>&amp;</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>peek</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>&#39; &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=bp>Self</span>::<span class=n>is_valid_for_identifier</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>advance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>Self</span>::<span class=n>is_keyword</span><span class=p>(</span><span class=o>&amp;</span><span class=n>buf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Token</span>::<span class=n>Keyword</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Token</span>::<span class=n>Name</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>name_or_keyword</code> 메서드 안에서는 <code>is_valid_for_identifier</code> 도우미 함수를 사용한다. 이 함수는 주어진 문자가 식별자(identifier)로 사용할 수 있는 문자인지 확인해 <code>true</code>/<code>false</code>를 리턴한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>is_valid_for_identifier</span><span class=p>(</span><span class=n>c</span>: <span class=kt>char</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>c</span><span class=p>.</span><span class=n>is_alphanumeric</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>&#39;_&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>식별자라고 생각하고 문자열을 읽은 수 <code>is_keyword</code> 도우미 함수로 키워드인지 판단한다. <code>is_keyword</code> 함수가 <code>true</code>를 리턴하면 <code>Keyword</code> 토큰을, <code>false</code>를 리턴하면 <code>Name</code> 토큰을 리턴한다.</p><p><code>is_keyword</code> 도우미 함수는 다음과 같다. 함수 안에서 Rust의 모든 키워드를 담은 <code>HashSet</code>을 가지고 있다. <a href=https://docs.rs/crate/lazy_static/latest>lasy_static</a> 또는 <a href=https://docs.rs/crate/phf/latest>phf</a>를 사용해 별도 키워드 집합을 정의할 수도 있지만, 여기서는 외부 종속성을 피하기 위해 사용하지 않았다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>is_keyword</span><span class=p>(</span><span class=n>name</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>keywords</span>: <span class=nc>HashSet</span><span class=o>&lt;&amp;</span><span class=kt>str</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HashSet</span>::<span class=o>&lt;</span><span class=n>_</span><span class=o>&gt;</span>::<span class=n>from_iter</span><span class=p>([</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;Self&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;abstract&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;as&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;async&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;await&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=s>&#34;while&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;yield&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>keywords</span><span class=p>.</span><span class=n>contains</span><span class=p>(</span><span class=n>name</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>이 함수는 Rust 키워드만 담고 있다. 다른 언어를 지원하는 것은 어려워 보이지 않는다. 어떻게 하면 여러 언어를 지원할 수 있는지는 직접 생각해보기 바란다.</p><h3 id=linecomment>LineComment</h3><p>이제 설명을 미루었던 <code>LineComment</code>, <code>BlockComment</code>를 설명하려 한다. 현재 문자가 <code>/</code>인 경우 다음 문자에 따라 토큰 타입이 바뀐다. 다음 문자도 <code>/</code>인 경우는 <code>LineComment</code>가, <code>*</code>인 경우는 <code>BlockComment</code>가 된다. 둘 다 아닌 경우에는 그냥 나눗셈을 나타내는 <code>/</code>인 경우이므로 <code>Punctation</code>이 될 것이다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>next_token</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>current_char</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>advance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>current_char</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=sc>&#39;/&#39;</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>peek</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nb>Some</span><span class=p>(</span><span class=sc>&#39;/&#39;</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>line_comment</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nb>Some</span><span class=p>(</span><span class=sc>&#39;*&#39;</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>block_comment</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nb>Some</span><span class=p>(</span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>punctuation</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>Token</span>::<span class=n>Eof</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>Token</span>::<span class=n>Eof</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>//</code>를 만난 경우에는 <code>line_comment</code> 메서드를 호출한다. <code>//</code>부터 해당 행의 끝까지를 <code>LineComment</code>로 보면 된다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>line_comment</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>current_char</span><span class=p>.</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=o>&amp;</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>peek</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>advance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>LineComment</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=blockcomment>BlockComment</h3><p><code>/*</code>를 만난 경우에는 <code>block_comment</code> 메서드를 호출한다. <code>*/</code>를 만날 때까지 계속 읽어야 한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>block_comment</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>current_char</span><span class=p>.</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=o>&amp;</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>peek</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>current_char</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>advance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>current_char</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=sc>&#39;*&#39;</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>peek</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=o>&amp;</span><span class=sc>&#39;/&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>current_char</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>advance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>buf</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=sc>&#39;/&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>BlockComment</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>그러나 <code>BlockComment</code>는 작업이 좀더 필요하다. <code>block_comment</code>는 <code>BlockComment</code> 토큰 하나를 리턴하므로 나중에 행번호와 함께 출력하고 싶은 경우 문제가 생긴다. 토큰 안에 여러 행을 갖고 있기 때문이다.</p><p>이건 렌더러에서 <code>BlockComment</code>를 별도 처리할 수도 있고 <code>BlockComment</code>를 사전에 여러 행으로 미리 나누어 놓을 수도 있다. <code>block_comment</code> 메서드가 행별로 나뉜 <code>BlockComment</code>의 리스트를 리턴하게 하는 방법은 고려 대상이 아니다. <code>nex_token</code> 메서드가 하나의 토큰을 리턴해야 하기 때문이다.</p><p>토큰 목록을 생성하는 것은 스캐너의 일이므로, 스캐너 안에서 <code>BlockComment</code>를 행별로 쪼개놓으려 한다.</p><p>따라서 다음과 같이 문자열을 받아 행별로 쪼개 <code>BlockComment</code> 목록을 리턴하는 도우미 함수를 만는다. 각 <code>BlockComment</code> 토큰 사이에 <code>Newline</code> 토큰을 넣어 주어야 한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>break_by_line</span><span class=p>(</span><span class=kt>str</span>: <span class=nb>String</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Token</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>bcl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>str</span><span class=p>.</span><span class=n>split</span><span class=p>(</span><span class=sc>&#39;\n&#39;</span><span class=p>).</span><span class=n>map</span><span class=p>(</span><span class=o>|</span><span class=n>line</span><span class=o>|</span><span class=w> </span><span class=n>Token</span>::<span class=n>BlockComment</span><span class=p>(</span><span class=n>line</span><span class=p>.</span><span class=n>into</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Vec</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>line</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bcl</span><span class=p>.</span><span class=n>next</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ret</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>line</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>bcl</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ret</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>Token</span>::<span class=n>NewLine</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ret</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>line</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>그리고 <code>scan</code> 메서드를 다음과 같이 수정한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>fn</span> <span class=nf>scan</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Token</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>tokens</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Token</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Vec</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=o>!</span><span class=bp>self</span><span class=p>.</span><span class=n>is_at_end</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>next_token</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>match</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Token</span>::<span class=n>Eof</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>break</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Token</span>::<span class=n>BlockComment</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>tokens</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>break_by_line</span><span class=p>(</span><span class=n>s</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>tokens</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>token</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>tokens</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>이렇게 해서 스캐너 구현이 끝났다.</p><h2 id=렌더링>렌더링</h2><p>토큰 목록만 있으면 렌더링은 식은죽 먹기다. 여기서는 콘솔 렌더러만 살펴 볼 것이지만, HTML 렌더러를 구현하는 것도 어렵지 않을 것이다.</p><p>먼저 다음과 같은 도우미 함수가 필요하다. 토큰 타입에 따라 적절한 색으로 바꾼다. 콘솔에서 출력 색상을 바꾸는 것은 <a href=https://github.com/ntalbs/colorust>colorust</a>를 사용했다. colorust는 <a href=https://github.com/colored-rs/colored>colored-rs</a>를 모방한 간단한 라이브러리로, <a href=https://en.wikipedia.org/wiki/ANSI_escape_code#Colors>ANSI 이스케이프 코드</a>를 사용해 출력 생상을 바꾼다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>render_token_to_console</span><span class=p>(</span><span class=n>token</span>: <span class=kp>&amp;</span><span class=nc>Token</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>String</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>Whitespace</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>into</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>NewLine</span><span class=p>()</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>.</span><span class=n>into</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>Punctuation</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>red</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>Number</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>yellow</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=nb>String</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>bright_magenta</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>LineComment</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>green</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>BlockComment</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>bright_green</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>Name</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>white</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Token</span>::<span class=n>Keyword</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>blue</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>.</span><span class=n>into</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>이제 입력 소스 코드를 콘솔로 렌더링하는 함수를 다음과 같이 작성할 수 있다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>render_to_console</span><span class=p>(</span><span class=n>input</span>: <span class=kp>&amp;</span><span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Token</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>input</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>print!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>render_token_to_console</span><span class=p>(</span><span class=n>token</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>행번호도 함께 출력하고 싶을 때는 다음 함수를 사용하면 된다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>render_to_console_with_line_num</span><span class=p>(</span><span class=n>input</span>: <span class=kp>&amp;</span><span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Token</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>num</span>: <span class=kt>usize</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>print!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{num:-3}</span><span class=s> &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>input</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>print!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>render_token_to_console</span><span class=p>(</span><span class=n>token</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=o>*</span><span class=n>token</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Token</span>::<span class=n>NewLine</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>num</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>print!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{num:-3}</span><span class=s> &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=마무리>마무리</h2><p>지금까지 문법 하이라이터를 작성하는 방법을 살펴보았다. 매우 초보적인 구현이라 실제로 사용하기는 어렵겠지만, 소스 코드 하이라이터를 어떤 식으로 만들 수 있는지 이해하는 데는 충분할 것이다.</p><p>여기서 구현한 문법 하이라이터는 Rust만 지원하고, 렌더링도 콘솔에 출력하는 방법만 살펴보았다. 그러나 위 설명을 잘 이해했다면, 다른 여러 언어를 지원하는 것이나 HTML 렌더러를 추가하는 것도 어렵지 않을 것이다.</p><h2 id=참고>참고</h2><ul><li><a href=https://github.com/ntalbs/prism-rs>prism-rs</a> 문법 하이라이터 전체 소스 코드를 확인할 수 있다.</li><li><a href=https://github.com/ntalbs/colorust>colorust</a> <a href=https://github.com/colored-rs/colored>colored-rs</a>를 흉내낸 간단한 라이브러리.</li></ul></section><footer class=post-footer><div class="social button-box"><a href=https://twitter.com/share class=twitter-share-button data-show-count=false>Tweet</a>
<a class=twitter-follow-button href=https://twitter.com/ntalbs data-show-count=false>Follow @ntalbs</a>
<script async src=//platform.twitter.com/widgets.js></script></div><nav id=article-nav><a class="article-nav-link-wrap next" href=/2023/previous-manager-danny/ id=article-nav-older>전 매니저, 대니</a></nav></footer></article></main><section class=section><div class=container><aside><div id=disqus_thread></div></aside><script type=text/javascript>var disqus_shortname="ntalbs-stuff",permalink="https://ntalbs.github.io/2024/syntax-highlighter-in-rust/".replace(/\//g,"/"),disqus_config=function(){this.page.url=permalink,this.page.identifier=permalink};(function(){var e=document,t=e.createElement("script");t.src="https://"+disqus_shortname+".disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p></p></div></section><script src=/js/index.js type=text/javascript></script><footer class=page-bottom><div class=inner><section class=copyright>© 2008-2024 <a href=/about>ntalbs</a></section><section class=poweredby>Powered by <a class=icon-ghost href=https://gohugo.io>Hugo</a></section></div></footer></body></html>